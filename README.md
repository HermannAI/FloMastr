# FloMastr Platform & WhappStream Product Suite

**The Relational AI Assistant for WhatsApp Business**

## ğŸš€ **Latest Updates - December 2025**

### **âœ… Complete Tenant Authentication System**
- **Tenant User Authentication**: Full authentication system for non-admin tenant users
- **JWT Processing**: Enhanced Clerk JWT token pr- âœ… **Error Resolution**: Fixed 500 errors in tenant resolution endpoint

---

## ğŸš€ **Production Deployment Plan**

### **Deployment Strategy: GitHub Actions CI/CD**

FloMastr uses **automated deployment via GitHub Actions** to deploy directly to our production server on every commit to the `main` branch.

### **ğŸ“ Current Infrastructure**

**âœ… Already Provisioned:**
- **Server**: DigitalOcean Droplet at `143.110.252.87` (Bangalore BLR1 region)
- **Database**: DigitalOcean PostgreSQL in Bangalore (BLR1) - `db-postgresql-blr1-flomastr-do-user-24629085-0.g.db.ondigitalocean.com`
- **Reverse Proxy**: Caddy reverse proxy configured with SSL
- **Existing Services**: 
  - WhatsApp Engine running on port 8000
  - Multiple tenant n8n containers
  - Shared Docker network for inter-container communication
- **Network**: Sub-1ms latency between server and database (same data center)

**Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Server: 143.110.252.87 (DigitalOcean BLR1)         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Caddy Reverse Proxy (SSL Termination)          â”‚ â”‚
â”‚  â”‚  engine.flomastr.com  â†’  WhatsApp Engine    (existing) â”‚ â”‚
â”‚  â”‚  api.flomastr.com     â†’  FloMastr Backend   (NEW)      â”‚ â”‚
â”‚  â”‚  app.flomastr.com     â†’  FloMastr Frontend  (NEW)      â”‚ â”‚
â”‚  â”‚  *.n8n.flomastr.com   â†’  Tenant n8n Containers         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  [WhatsApp Engine:8000] [FloMastr Backend:8001]             â”‚
â”‚  [FloMastr Frontend:5173] [n8n Containers]                  â”‚
â”‚                                                              â”‚
â”‚  All containers connected via flomastr-network              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                      < 1ms latency
                            â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  PostgreSQL (BLR1 Bangalore) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ğŸ¯ Deployment Workflow**

**Automated Process:**
```
1. Developer commits code to GitHub (main branch)
2. GitHub Actions workflow triggers automatically
3. Workflow SSHs into production server (143.110.252.87)
4. Pulls latest code from GitHub
5. Rebuilds Docker containers
6. Restarts services with zero-downtime deployment
7. Cleans up old Docker images
8. Deployment complete! âœ…
```

**Benefits:**
- âœ… **Fully Automated** - No manual server access needed
- âœ… **Fast Deployment** - 2-5 minutes from commit to live
- âœ… **Deployment History** - All deployments logged in GitHub Actions
- âœ… **Rollback Ready** - Revert commit to rollback deployment
- âœ… **Free** - GitHub Actions included (2,000 minutes/month)

---

### **ğŸ“‹ Pre-Deployment Checklist**

**Before deploying to production, ensure:**

#### **1. Infrastructure Setup**
- [ ] Server `143.110.252.87` is accessible via SSH
- [ ] Docker and Docker Compose installed on server
- [ ] Shared Docker network `flomastr-network` created
- [ ] Existing containers connected to shared network
- [ ] Sufficient server resources (8-16GB RAM recommended)

#### **2. DNS Configuration**
- [ ] DNS A record: `api.flomastr.com` â†’ `143.110.252.87`
- [ ] DNS A record: `app.flomastr.com` â†’ `143.110.252.87`
- [ ] DNS propagated (wait 5-10 minutes after creation)

#### **3. Caddy Configuration**
- [ ] Caddy reverse proxy routes added for FloMastr
- [ ] SSL certificates auto-generated by Caddy
- [ ] Routes tested and responding

#### **4. GitHub Secrets**
- [ ] SSH private key added to GitHub repository secrets as `SSH_PRIVATE_KEY`
- [ ] Secret has proper permissions for server access

#### **5. Production Environment**
- [ ] Production environment variables configured (see below)
- [ ] Database connection string tested
- [ ] Super admin emails configured
- [ ] API keys for OpenAI, Clerk, etc. set up

---

### **âš™ï¸ Deployment Setup Instructions**

#### **Step 1: Generate SSH Keys for GitHub Actions**

On your local machine:
```bash
# Generate dedicated SSH key for GitHub Actions
ssh-keygen -t ed25519 -C "github-actions-flomastr" -f ~/.ssh/flomastr-deploy

# Copy public key to server
ssh-copy-id -i ~/.ssh/flomastr-deploy.pub root@143.110.252.87

# Display private key (copy the entire output)
cat ~/.ssh/flomastr-deploy
```

#### **Step 2: Add SSH Key to GitHub Secrets**

1. Go to: `https://github.com/HermannAI/FloMastr/settings/secrets/actions`
2. Click **"New repository secret"**
3. Name: `SSH_PRIVATE_KEY`
4. Value: Paste the entire private key content from step 1
5. Click **"Add secret"**

#### **Step 3: Create Production Docker Compose File**

SSH into server and create production configuration:
```bash
ssh root@143.110.252.87
cd /opt
git clone https://github.com/HermannAI/FloMastr.git
cd FloMastr

# Create production docker-compose file
cat > docker-compose.production.yml <<'EOF'
version: '3.8'

networks:
  flomastr-network:
    external: true  # Use existing shared network

services:
  flomastr-backend:
    build: ./backend
    container_name: flomastr-backend
    ports:
      - "8001:8000"  # Avoid conflict with WhatsApp Engine on 8000
    env_file:
      - .env.production
    networks:
      - flomastr-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  flomastr-frontend:
    build: ./frontend
    container_name: flomastr-frontend
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=production
      - VITE_API_BASE_URL=https://api.flomastr.com
    depends_on:
      - flomastr-backend
    networks:
      - flomastr-network
    restart: unless-stopped
    command: npm run dev -- --host 0.0.0.0
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
EOF

# Create production environment file
cat > .env.production <<'EOF'
DATABASE_URL=postgresql://doadmin:AVNS_60oX1gbkyUjUxv2y63s@db-postgresql-blr1-flomastr-do-user-24629085-0.g.db.ondigitalocean.com:25060/defaultdb?sslmode=require
SUPER_ADMIN_EMAILS=hermann@changemastr.com,service@changemastr.com
ENVIRONMENT=production
WHATSAPP_ENGINE_URL=http://whatsapp-engine:8000
# Add additional production secrets here:
# OPENAI_API_KEY=sk-...
# CLERK_SECRET_KEY=...
# INFOBIP_API_KEY=...
EOF

# Secure environment file
chmod 600 .env.production
```

#### **Step 4: Update Caddy Configuration**

```bash
# Edit Caddyfile on server
nano /etc/caddy/Caddyfile

# Add these routes (keep existing routes):
api.flomastr.com {
    reverse_proxy localhost:8001
}

app.flomastr.com {
    reverse_proxy localhost:5173
}

# Save and reload Caddy
systemctl reload caddy
```

#### **Step 5: Create GitHub Actions Workflow**

Create `.github/workflows/deploy.yml` in your repository:

```yaml
name: Deploy FloMastr to Production

on:
  push:
    branches:
      - main  # Auto-deploy on every push to main

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to DigitalOcean Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 143.110.252.87
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting FloMastr deployment..."
            cd /opt/FloMastr
            
            echo "ğŸ“¦ Pulling latest code from GitHub..."
            git pull origin main
            
            echo "ğŸ›‘ Stopping containers..."
            docker-compose -f docker-compose.production.yml down
            
            echo "ğŸ—ï¸  Building containers with latest code..."
            docker-compose -f docker-compose.production.yml build --no-cache
            
            echo "â–¶ï¸  Starting containers..."
            docker-compose -f docker-compose.production.yml up -d
            
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker system prune -f
            
            echo "âœ… Deployment completed at $(date)"
            
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 143.110.252.87
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ” Verifying container status..."
            docker ps | grep flomastr
            
            echo "ğŸ“Š Recent container logs:"
            docker-compose -f /opt/FloMastr/docker-compose.production.yml logs --tail=30
            
            echo "ğŸ¥ Testing backend health endpoint..."
            curl -f http://localhost:8001/health || echo "âš ï¸  Backend health check failed"
            
            echo "âœ… Deployment verification complete"
```

Commit and push this file:
```bash
git add .github/workflows/deploy.yml
git commit -m "Add automated production deployment workflow"
git push origin main
```

---

### **ğŸ‰ Deployment Activation**

**Once all setup steps are complete:**

1. **Test deployment** by pushing a commit to `main`:
   ```bash
   git commit --allow-empty -m "Test production deployment"
   git push origin main
   ```

2. **Monitor deployment** in GitHub:
   - Go to: `https://github.com/HermannAI/FloMastr/actions`
   - Watch the deployment run in real-time
   - Check for any errors in the workflow logs

3. **Verify services** are running:
   ```bash
   # SSH into server
   ssh root@143.110.252.87
   
   # Check containers
   docker ps | grep flomastr
   
   # Check logs
   docker-compose -f /opt/FloMastr/docker-compose.production.yml logs -f
   ```

4. **Access deployed application:**
   - Frontend: `https://app.flomastr.com`
   - API Docs: `https://api.flomastr.com/docs`
   - Health Check: `https://api.flomastr.com/health`

---

### **ğŸ“Š Post-Deployment Monitoring**

**Check deployment status:**
```bash
# View all FloMastr containers
docker ps | grep flomastr

# Check resource usage
docker stats flomastr-backend flomastr-frontend

# View logs
docker logs flomastr-backend --tail=100 -f
docker logs flomastr-frontend --tail=100 -f

# Test API endpoints
curl https://api.flomastr.com/health
curl https://api.flomastr.com/docs
```

**Monitor server resources:**
```bash
# SSH into server
ssh root@143.110.252.87

# Check CPU and memory
htop

# Check disk space
df -h

# Check Docker resource usage
docker stats
```

---

### **ğŸ”„ Ongoing Deployment Process**

**After initial setup, deployment is automatic:**

```bash
# Make code changes locally
git add .
git commit -m "Add new feature"
git push origin main

# GitHub Actions automatically:
# 1. Detects push to main
# 2. SSHs into server
# 3. Pulls latest code
# 4. Rebuilds containers
# 5. Restarts services
# 6. Deployment complete in 2-5 minutes! ğŸ‰
```

**View deployment history:**
- Go to: `https://github.com/HermannAI/FloMastr/actions`
- See all deployments, their status, and logs

**Rollback if needed:**
```bash
# Revert to previous commit
git revert HEAD
git push origin main

# GitHub Actions will automatically deploy the reverted version
```

---

### **ğŸ” Production Environment Variables**

**Required environment variables in `.env.production` on server:**

```env
# Database
DATABASE_URL=postgresql://doadmin:AVNS_60oX1gbkyUjUxv2y63s@db-postgresql-blr1-flomastr-do-user-24629085-0.g.db.ondigitalocean.com:25060/defaultdb?sslmode=require

# Super Admin Access
SUPER_ADMIN_EMAILS=hermann@changemastr.com,service@changemastr.com

# Environment
ENVIRONMENT=production

# Internal Service URLs (Docker network)
WHATSAPP_ENGINE_URL=http://whatsapp-engine:8000

# API Keys (add when ready)
OPENAI_API_KEY=sk-...
CLERK_SECRET_KEY=...
CLERK_PUBLISHABLE_KEY=pk-...
INFOBIP_API_KEY=...
BACKEND_API_SECRET_TOKEN=...

# n8n Configuration
N8N_MASTER_URL=https://master.n8n.flomastr.com
N8N_MASTER_API_KEY=...
```

---

### **ğŸ› ï¸ Deployment Troubleshooting**

**Common issues and solutions:**

**1. GitHub Actions SSH fails:**
```bash
# Verify SSH key is correct in GitHub Secrets
# Test SSH connection manually:
ssh -i ~/.ssh/flomastr-deploy root@143.110.252.87
```

**2. Container build fails:**
```bash
# SSH into server and check logs
cd /opt/FloMastr
docker-compose -f docker-compose.production.yml logs

# Rebuild manually with verbose output
docker-compose -f docker-compose.production.yml build --no-cache
```

**3. Containers won't start:**
```bash
# Check for port conflicts
netstat -tulpn | grep -E '8001|5173'

# Check Docker logs
docker logs flomastr-backend
docker logs flomastr-frontend
```

**4. DNS not resolving:**
```bash
# Check DNS propagation
dig api.flomastr.com
dig app.flomastr.com

# Wait 5-10 minutes for DNS to propagate
```

**5. Caddy SSL issues:**
```bash
# Check Caddy logs
journalctl -u caddy -f

# Reload Caddy
systemctl reload caddy
```

---

### **âœ… Deployment Status**

**Current Status:** Ready for deployment

**Completed:**
- âœ… Development environment fully functional in Codespaces
- âœ… Docker containerization working
- âœ… Database connection established
- âœ… Authentication system implemented
- âœ… API endpoints tested and working
- âœ… Frontend UI complete with tenant routing

**Pending for Production:**
- â³ SSH keys generated and added to GitHub Secrets
- â³ Production Docker Compose file created on server
- â³ GitHub Actions workflow file committed to repository
- â³ DNS records configured
- â³ Caddy reverse proxy updated with FloMastr routes
- â³ Production environment variables configured
- â³ First deployment executed and verified

**Next Steps:**
1. Follow "Deployment Setup Instructions" above
2. Complete Pre-Deployment Checklist
3. Push workflow file to trigger first deployment
4. Monitor deployment in GitHub Actions
5. Verify services at `app.flomastr.com` and `api.flomastr.com`

---

## Environment Configuration

## ğŸ“š Core Documentationing with email fallback support
- **HITL Tasks Integration**: Working HITL (Human-in-the-Loop) tasks system with tenant isolation
- **Database Updates**: Tenant memberships aligned with Clerk user IDs for proper authorization

### **ğŸ¨ Consistent UI/UX Architecture** 
- **Shared Layout Component**: All tenant pages now use consistent header/footer layout
- **shadcn/ui Components**: Complete component library with table, select, separator, skeleton
- **Tenant-Aware Navigation**: Header navigation dynamically adapts for admin vs tenant users
- **Professional Branding**: Consistent FloMastr branding and legal footer across all pages

### **ğŸ—ï¸ Clean Tenant Routing Architecture**
- **Path-Based Tenant Routing**: All tenant pages use `/:tenantSlug/page` URL pattern (e.g., `/acme/hitl-tasks`)
- **Tenant Isolation**: Complete multi-tenant data isolation via path-based routing
- **Route Cleanup**: Removed direct tenant routes, enforcing proper tenant isolation
- **Navigation Consistency**: All tenant navigation uses tenant-prefixed paths

### **ğŸ”§ Technical Improvements**
- **FastAPI Dependencies**: Fixed incorrect dependency injection patterns causing 500 errors
- **CSS Animations**: Added `tailwindcss-animate` for proper component animations
- **Development Experience**: Hot reloading, error handling, and debugging improvements
- **API Documentation**: Comprehensive endpoint documentation with authentication patterns

## GitHub Codespaces Deployment

This application is designed for containerized deployment using Docker and Docker Compose, with full support for GitHub Codespaces.

### Quick Start (GitHub Codespaces)

**Prerequisites:**
- GitHub Codespaces enabled on your account

**Start Application:**
```bash
# Quick start script (recommended)
./codespaces-start.sh

# OR manual startup:
docker-compose up -d

# View logs
docker-compose logs -f backend
docker-compose logs -f frontend
```

**Access Services:**
- Backend API: https://YOUR_CODESPACE_NAME-8000.app.github.dev/docs
- Backend Health: https://YOUR_CODESPACE_NAME-8000.app.github.dev/health
- Frontend: https://YOUR_CODESPACE_NAME-5173.app.github.dev
- Tenant Resolution: https://YOUR_CODESPACE_NAME-5173.app.github.dev/routes/resolve-tenant?email=hermann@changemastr.com

### Docker-Only Deployment (Local Development)

### Container Architecture

**Backend Container:**
- **Base Image**: `python:3.11-slim`
- **Working Directory**: `/app`
- **Port**: 8000 (mapped to host:8000)
- **Hot Reloading**: Enabled via volume mount
- **Dependencies**: Optimized 11 essential packages (reduced from 100+)
  - `asyncpg`, `fastapi`, `httpx`, `openai`, `pydantic[email]`
  - `PyJWT`, `PyPDF2`, `python-dotenv`, `python-multipart` 
  - `requests`, `starlette`, `uvicorn`
- **Authentication**: Super admin resolution working with proper tenant routing

**Backend Container:**
- Python 3.11 environment
- FastAPI application with hot reloading
- Automatic dependency management
- Database migrations and health checks
- Port 8000 exposed

**Frontend Container:**
- **Base Image**: `node:18-alpine`
- **Working Directory**: `/app`
- **Port**: 5173 (mapped to host:5173)
- **Hot Reloading**: Vite dev server with auto-refresh
- **Framework**: React + TypeScript + Tailwind CSS
- **API Proxy**: Configured for `/routes/*` and `/api/*` â†’ `backend:8000`
- **Import Resolution**: Optimized path aliases for consistent imports
- **Authentication**: AuthMiddleware properly handles super admin routing

**Container Benefits:**
- No virtual environment needed - container provides isolation
- Consistent Python version - always Python 3.11
- Automatic dependency management - pip install handled by Docker
- Cross-platform compatibility - works on any system with Docker
- Production parity - same environment as deployment

**Docker Development Commands:**
```bash
# Access backend container shell
docker-compose exec backend bash

# View backend logs
docker-compose logs -f backend

# Restart backend after code changes
docker-compose restart backend

# Run database migrations
docker-compose exec backend python migrate_schema.py
```

### Development Setup

#### Quick Start
```bash
# Clone and start development environment
cd FloMastr
docker-compose up --build

# Access services:
# Backend: http://localhost:8000
# Frontend: http://localhost:5173
```

#### Development Workflow
```bash
# Start with logs
docker-compose up

# Start in background
docker-compose up -d

# Restart specific service
docker-compose restart backend

# View logs
docker-compose logs backend
docker-compose logs -f backend  # Follow logs

# Stop all services
docker-compose down

# Rebuild after changes
docker-compose up --build
```

#### Environment Variables
The following environment variables are configured in `docker-compose.yml`:

**Backend Environment:**
```env
DATABASE_URL=postgresql://doadmin:AVNS_60oX1gbkyUjUxv2y63s@db-postgresql-blr1-flomastr-do-user-24629085-0.g.db.ondigitalocean.com:25060/defaultdb?sslmode=require
SUPER_ADMIN_EMAILS=hermann@changemastr.com,service@changemastr.com
```

**Frontend Environment:**
```env
NODE_ENV=development
VITE_API_BASE_URL=http://localhost:8000
```

**Key Configuration Notes:**
- âœ… **Super Admin Access**: `hermann@changemastr.com` and `service@changemastr.com` have admin privileges
- âœ… **API Proxy**: Frontend `/routes/*` and `/api/*` requests proxy to backend
- âœ… **Hot Reloading**: Both services support live code updates
- âœ… **Docker Service Communication**: Services communicate via Docker network using service names

#### Development Benefits
- **âœ… Consistent Environment**: Same setup on all platforms (Windows, macOS, Linux)
- **âœ… No Local Dependencies**: No Python, Node.js, or database installation needed
- **âœ… Hot Reloading**: Code changes automatically reflected in containers
- **âœ… Easy Debugging**: Container logs and shell access via `docker-compose exec`
- **âœ… Production Parity**: Same containerized environment as production deployment
- **âœ… Super Admin Routing**: Proper authentication and tenant resolution working
- **âœ… API Communication**: Frontend-backend proxy correctly configured for Docker networking

#### Troubleshooting
**Common Issues:**
1. **Port conflicts**: Ensure ports 8000 and 5173 are available
2. **Container startup**: Use `docker-compose logs service-name` to debug issues
3. **API connectivity**: All `/routes/*` requests from frontend proxy to backend automatically
4. **Super admin access**: Use `hermann@changemastr.com` for admin dashboard access
5. **Dependency issues**: Rebuild containers with `docker-compose up --build` if dependencies change
6. **Container cache issues**: Use `docker-compose build --no-cache` if code changes aren't reflected
7. **Authentication 401 errors**: Check that frontend SecurityWorker is adding X-User-Email header automatically

### **ğŸš¨ Recent Issue Resolutions**

**Container Deployment Problems:**
```bash
# If code changes aren't reflected in container:
docker-compose down
docker system prune -f  # Clear cache
docker-compose build --no-cache
docker-compose up -d

# Verify container is using updated code:
docker-compose logs backend | grep "FLOMASTR_MAIN_PY"  # Should show debug message
curl http://localhost:8000/test-super-admin?email=hermann@changemastr.com  # Should return 200
```

**Authentication Issues:**
```bash
# Test super admin bypass is working:
curl -H "X-User-Email: hermann@changemastr.com" http://localhost:5173/api/routes/tenants?limit=500
# Should return 200 with tenant data (not 401/403)

# Debug frontend SecurityWorker:
# Check browser console for "ğŸ” SECURITY WORKER: Called!" messages
# Verify "ğŸ” Security Worker - Headers:" shows email properly
```

**Database Model Issues:**
- âœ… **Fixed**: Tenant model now handles UUID primary keys (was expecting int)
- âœ… **Fixed**: Optional/nullable fields (inbox_scope, confidence_threshold) properly handled
- âœ… **Fixed**: Pydantic validation errors resolved for database schema mismatch

### **ğŸ” Authentication & Super Admin Access - SIMPLIFIED APPROACH**

**Simplified Super Admin Configuration:**
- âœ… **Configured Emails**: `hermann@changemastr.com`, `service@changemastr.com` (via `SUPER_ADMIN_EMAILS` env var)
- âœ… **Email-Based Access**: Simple email verification for all admin endpoints
- âœ… **Direct API Access**: All admin routes bypass complex authentication
- âœ… **Simplified Security**: Super admin helpers in `backend/main.py` handle access control

**Key Simplification Changes:**
- **Backend**: Removed complex auth dependencies, added simple super admin helper functions
- **Frontend**: AuthMiddleware bypasses auth for admin routes (`authRequired: false`)
- **API Client**: Simplified security worker includes user email in `X-User-Email` header
- **Route Access**: All admin endpoints use `check_super_admin_access(request)` function

**Testing Super Admin Access:**
```bash
# Test super admin users endpoint (now returns real database data)
curl -X GET "http://localhost:8000/routes/users" \
  -H "X-User-Email: hermann@changemastr.com"
# Expected response: Real user data from user_roles table with UUIDs, timestamps, etc.

# Test tenant endpoint through frontend proxy (should work automatically)
curl "http://localhost:5173/api/routes/tenants?limit=500"
# Frontend SecurityWorker should automatically add X-User-Email header

# Test tenant resolution (frontend proxy)
curl "http://localhost:5173/routes/resolve-tenant?email=hermann%40changemastr.com"
# Expected response: {"tenant_slug":null,"tenant_name":"Super Admin","is_super_admin":true,"found":true}

# Debug super admin detection
curl "http://localhost:8000/test-super-admin?email=hermann@changemastr.com"
# Expected: {"email":"hermann@changemastr.com","is_super_admin":true,"super_admin_emails":["hermann@changemastr.com","service@changemastr.com"],"message":"Test endpoint working"}

# Login flow (âœ… WORKING):
# 1. Navigate to http://localhost:5173
# 2. Login with hermann@changemastr.com (Clerk auth)
# 3. Frontend SecurityWorker automatically adds email to all API requests
# 4. Backend detects super admin email and bypasses authentication
# 5. Should automatically redirect to admin dashboard with full tenant access
```

**Super Admin Endpoints Available:**
- `GET /routes/users` - List all users (âœ… FIXED - Now returns real database data from user_roles table)
- `POST /routes/users/roles` - Update user roles  
- `GET /routes/tenants` - List all tenants with full data (âœ… FIXED - UUID/nullable field validation)
- `GET /routes/tenants-direct` - Direct tenant endpoint for testing
- `GET /test-super-admin` - Debug endpoint to verify super admin detection
- All existing admin endpoints with simplified access control

**Recent Critical Fixes (December 2025):**
- âœ… **Tenant Slug Architecture**: Enforced consistent `/:tenantSlug/page` URL structure for all tenant pages
- âœ… **UI Component System**: Added complete shadcn/ui component library (table, select, separator, skeleton)
- âœ… **CSS Animations**: Fixed `tailwindcss-animate` dependency for proper component animations
- âœ… **FastAPI Dependencies**: Corrected incorrect `AuthorizedUser = Depends()` patterns causing 500 errors
- âœ… **Shared Layout Component**: All tenant pages now use consistent header/footer with professional branding
- âœ… **Header Navigation**: Updated navigation to use tenant-prefixed paths for proper routing
- âœ… **Route Cleanup**: Removed direct tenant routes, enforcing tenant isolation through URL structure
- âœ… **Workflows Page**: Fixed 500 errors and added proper skeleton loading states
- âœ… **HITL Tasks Integration**: Complete tenant-aware HITL tasks system with proper authentication

**Previous Fixes (September 2025):**
- âœ… **Real User Data**: Fixed admin users page to show real database users instead of mock data
- âœ… **API Routing**: Resolved conflict between mock /routes/users endpoint and real user_management API
- âœ… **Container Deployment**: Fixed Docker build cache preventing code updates from loading
- âœ… **Pydantic Model**: Updated Tenant model to handle UUID fields and nullable strings from database
- âœ… **Frontend SecurityWorker**: Fixed automatic X-User-Email header injection for super admin bypass
- âœ… **Authentication Flow**: Complete end-to-end super admin bypass working (401 â†’ 200 responses)
- âœ… **Hot Reloading**: Resolved main.py syntax errors causing container startup failures
- âœ… **Tenant Authentication**: Complete tenant user authentication system for non-admin users
- âœ… **JWT Authentication**: Fixed Clerk JWT token processing with email fallback support
- âœ… **HITL Tasks System**: Created active_hitl_tasks table and working tenant-aware endpoints
- âœ… **Frontend UI Components**: Added missing table, select, separator components for HITL tasks page
- âœ… **Database Migration**: Updated tenant memberships with correct Clerk user IDs

### **ğŸ” Tenant User Authentication - NEW**

**Tenant User Access (Non-Admin):**
- âœ… **Tenant Resolution**: Email-based tenant lookup (e.g., `hermann@whappstream.com` â†’ `whappstream` tenant)
- âœ… **JWT Processing**: Clerk JWT token validation with X-User-Email header fallback
- âœ… **User ID Mapping**: Automatic tenant membership resolution by Clerk user ID
- âœ… **Tenant Context**: All API endpoints include proper tenant context for data isolation

**Testing Tenant User Access:**
```bash
# Test tenant user authentication (HITL tasks example)
curl -X GET "http://localhost:8000/routes/api/v1/tasks" \
  -H "Authorization: Bearer CLERK_JWT_TOKEN" \
  -H "X-User-Email: hermann@whappstream.com"
# Expected: Returns HITL tasks for whappstream tenant (200 response)

# Frontend URL for tenant users:
https://YOUR_CODESPACE-5173.app.github.dev/whappstream/hitl-tasks
# Should load successfully with proper tenant authentication
```

**Tenant Authentication Architecture:**
- **Backend**: `TenantUserByEmailDep` dependency for tenant-aware endpoints
- **Frontend**: Clerk authentication with automatic email header injection
- **Database**: Tenant memberships linked to Clerk user IDs for proper authorization
- **UI**: Complete HITL tasks interface with table, filters, and tenant-specific data

**Technical Implementation:**
- `backend/main.py`: Contains `is_super_admin_email()`, `check_super_admin_access()` functions
- `backend/app/libs/models.py`: Updated Tenant model with Union[int, str, uuid.UUID] for id field
- `frontend/src/brain/index.ts`: Fixed security worker with comprehensive logging and email detection
- `frontend/src/components/AuthMiddleware.tsx`: Admin routes bypass authentication with proper super admin detection

**Frontend-Backend API Communication:**
- âœ… **Proxy Configuration**: Frontend `/routes/*` requests forward to `backend:8000`
- âœ… **Docker Networking**: Services communicate via Docker service names
- âœ… **Development Setup**: Hot reloading maintains API connectivity
- âœ… **User Management API**: Admin users page now displays real database data via `/routes/users` endpoint
- âœ… **API Routing**: Resolved conflict between mock endpoints and real user_management API
- âœ… **Error Resolution**: Fixed 500 errors in tenant resolution endpoint

## Environment Configuration

## ï¿½ Core Documentation

### **System Architecture**
- [**INFRASTRUCTURE.md**](./INFRASTRUCTURE.md) - Complete system architecture, service topology, and deployment configuration
- [**DATABASE_ARCHITECTURE.md**](./DATABASE_ARCHITECTURE.md) - Database design, hot storage schema, and data flow architecture
- [**UI_ARCHITECTURE.md**](./UI_ARCHITECTURE.md) - Frontend architecture, component design, and user experience framework
- [**LANGCHAIN_INTEGRATION.md**](./LANGCHAIN_INTEGRATION.md) - AI framework integration for advanced language processing and intelligent reasoning

### **Core Product Documentation**
- [**BUSINESS_BRAIN.md**](./BUSINESS_BRAIN.md) - AI-powered knowledge engine with contextual retrieval system
- [**WORKFLOW_GALLERY.md**](./WORKFLOW_GALLERY.md) - WhappStream intelligent automation and workflow templates
- [**WHATSAPP_ENGINE.md**](./WHATSAPP_ENGINE.md) - Centralized WhatsApp message processing with InfoBip integration
- [**DATA_ENGINE.md**](./DATA_ENGINE.md) - Real-time database and API integration framework
- [**RELATIONAL_PULSE.md**](./RELATIONAL_PULSE.md) - Proactive customer engagement with weekly personalized WhatsApp communications

### **Migration & Development**
- [**API_MIGRATION_STATUS.md**](./API_MIGRATION_STATUS.md) - Backend API migration status and endpoint documentation

### **Current Status: âœ… Migration Complete - Independent FastAPI Backend**

Our FastAPI backend is fully independent and implements all necessary endpoints. All endpoints are prefixed with `/routes/` in our new setup.

### **ğŸ› ï¸ Tools Endpoints (n8n Integration Ready)**
```
POST /routes/tools/synthesis - Main synthesis endpoint
POST /routes/tools/generate/answer - Generate AI answers  
POST /routes/tools/prepare/context - Prepare context for AI workflows
POST /routes/tools/convert/file-to-md - Convert files to markdown
POST /routes/tools/convert/url-to-md - Convert URLs to markdown
POST /routes/tools/embed/knowledge - Embed knowledge content
```

## ğŸ—ï¸ Technical Architecture

### **Multi-Tenant Authentication Patterns**
```
Super Admin Access:
- X-User-Email header OR ?email= query parameter
- Bypass tenant restrictions, see all tenant data
- Access to admin provisioning endpoints

Tenant User Access:  
- Clerk JWT token authentication via Authorization header
- Tenant resolution by email domain mapping
- Restricted to tenant-specific data only
```

### **Backend API Structure**
```
backend/app/apis/{module}/
â”œâ”€â”€ __init__.py        # FastAPI router with endpoints
â”œâ”€â”€ models.py          # Pydantic request/response models  
â”œâ”€â”€ dependencies.py    # Auth dependencies (TenantDep, etc.)
â””â”€â”€ database.py        # Database query functions

Common Dependencies:
- TenantDep: Resolve tenant from path (/tenant/{slug})
- TenantUserByEmailDep: Resolve tenant by authenticated email
- SuperAdminDep: Require super admin access
```

### **Frontend Architecture**
```
frontend/src/
â”œâ”€â”€ brain/             # API client (auto-generated from OpenAPI)
â”œâ”€â”€ components/ui/     # shadcn/ui components
â”œâ”€â”€ pages/            # Route components
â”œâ”€â”€ hooks/            # Custom React hooks
â””â”€â”€ lib/              # Utilities and configurations

Authentication Flow:
1. Clerk handles login/logout
2. JWT token sent in Authorization header  
3. Backend validates token and extracts email
4. Tenant resolved by email domain mapping
5. User restricted to tenant-specific resources
```

---

### **ğŸ¢ Tenant Management**
```
GET /routes/tenants - List all tenants
GET /routes/tenants/{tenant_slug} - Get specific tenant  
POST /routes/tenants - Create new tenant
PUT /routes/tenants/{tenant_slug} - Update tenant
PUT /routes/tenants/{tenant_slug}/policies - Update tenant policies
DELETE /routes/tenants/{tenant_slug} - Delete tenant
GET /routes/resolve-tenant - Resolve tenant from request
POST /routes/resolve-tenant - Resolve tenant (POST method)

# Admin Functions
POST /routes/api/v1/admin/tenants/provision - Provision new tenant (NEW)
GET /routes/check-super-admin - Check super admin status
```

### **ğŸ’¬ Conversations & Chat**
```
POST /routes/api/v1/conversations/ingest - Ingest chat messages
GET /routes/api/v1/conversations/health - Health check for conversations
POST /routes/webchat/sessions - Create webchat session  
GET /routes/webchat/sessions/{session_key} - Get webchat session
```

### **ğŸ¨ Branding & Customization**
```
GET /routes/tenant-profile - Get tenant profile
PUT /routes/tenant-profile - Update tenant profile
GET /routes/branding - Get branding settings
PUT /routes/branding - Update branding settings
```

### **ğŸ§  Knowledge Management**
```
GET /routes/knowledge/health - Knowledge system health
GET /routes/knowledge/{tenant_slug}/index - Get knowledge index
POST /routes/knowledge/{tenant_slug}/index - Upsert knowledge index
```

> ğŸ“– **For detailed Business Brain documentation** including RAG architecture, ingestion workflows, and database schemas, see **[BUSINESS_BRAIN.md](./BUSINESS_BRAIN.md)**

### **ğŸ‘¥ Human-in-the-Loop Tasks (HITL) - âœ… WORKING**
```
GET /routes/tasks - Get HITL tasks (legacy endpoint)
GET /routes/api/v1/tasks - Get active HITL tasks (tenant-aware)
GET /routes/tasks/{task_id} - Get specific task details
POST /routes/tasks - Create HITL task  
POST /routes/tasks/{task_id}/resolve - Resolve HITL task
```

**HITL Tasks Features:**
- âœ… **Tenant Isolation**: Tasks are filtered by authenticated user's tenant
- âœ… **Database Table**: `active_hitl_tasks` with proper UUID foreign keys
- âœ… **Frontend Interface**: Complete UI with table, filters, and status badges
- âœ… **Authentication**: Works with both super admin and tenant user access
- âœ… **Sample Data**: Includes sample task for testing and development

**Frontend HITL Pages:**
- `/hitl-tasks` - Main HITL tasks dashboard with filters and search
- `/hitl-tasks/{taskId}` - Individual task detail view
- Admin can see all tenant tasks, tenant users see only their own tenant's tasks

### **âš™ï¸ Platform & System**
```
GET /routes/manifest - Get platform manifest
GET /routes/preflight - Preflight checks
GET /routes/envelope - Get context envelope
GET /routes/favicon.ico - Favicon
```

### **ğŸ” User Management & Auth**
```
GET /routes/users - List users
POST /routes/users - Create user
GET /routes/me/role - Get current user role
GET /routes/me/status - Get user status
GET /routes/debug/jwt - Debug JWT token
GET /routes/debug/auth-status - Debug auth status
```

### **ğŸ”„ Workflow & Lifecycle**
```
POST /routes/install-workflow - Install workflow
GET /routes/workflow-templates - Get workflow templates
POST /routes/suspend - Suspend tenant
POST /routes/reactivate - Reactivate tenant
POST /routes/soft-delete - Soft delete tenant
POST /routes/restore - Restore tenant
POST /routes/hard-delete - Hard delete tenant
GET /routes/status/{tenant_id} - Get tenant status
```

### **ğŸ“‹ Additional Endpoints (Future Implementation)**
```
# These endpoints may be implemented as needed for future features:
GET /routes/workflows - Get available workflows
GET /routes/bundles - List bundles
POST /routes/bundles - Create bundle
GET /routes/tenants/{tenant_slug}/bundles - List tenant bundles
PUT /routes/tenants/{tenant_slug}/bundles/{bundle_name} - Install/update bundle
GET /routes/deploy/tenant/{tenant_slug}/bundle/{bundle_name} - Get deploy snippet
POST /routes/branding/{tenant_id}/upload-logo - Upload tenant logo
DELETE /routes/branding/{tenant_id}/reset - Reset branding settings
```

### **ğŸš¨ Important: URL Prefix Change**
- **Legacy systems**: May have used `/api/` prefix
- **Current FastAPI**: Uses `/routes/` prefix
- **Update Required**: n8n workflows need URL updates from `/api/` to `/routes/`

## ï¿½ğŸ‘¥ Team & Collaboration

### **Our Partnership Model**
- **Gemini (Chief Architect)**: Maintains vision integrity, ensures development aligns with guiding philosophy, provides implementation guidance
- **Hermann (Project Lead)**: Executes development, manages workflow, operational oversight  
- **GitHub Copilot (Technical Assistant)**: Performs technical work, provides progress reports, maintains audit trail
- **SuperAI (Problem Solver)**: Assists with complex technical challenges through synthesized solutions

### **Development Workflow**
Every major feature begins with:
1. ğŸ“‹ Strategic review of architecture document
2. ğŸ’­ Discussion of implementation options  
3. ğŸ¤ Joint decision before execution
4. ğŸ”„ Progress reporting and iteration

##  Core Database Schemaend server and a React + TypeScript frontend application, designed to build the definitive Relational AI Assistant for businesses on WhatsAppâ€”a partner so contextually aware and capable of learning that it stands in a category of its own.

## ğŸ§  Guiding Philosophy: The Relational AI Partner

Our mission is to empower businesses to forge genuine, lasting relationships with their customers through meaningful, intelligent conversation. We are building a system with a **"Conversational Memory"** that remembers, learns, and builds context from every interaction, making each conversation more personal and effective than the last.

Every architectural decision must serve this core principle: contextual awareness and relationship building through AI.

## ğŸ—ï¸ Core Engine Architecture

Our architecture is composed of three distinct, interacting engines:

- **Context Engine**: Ingests and retrieves a tenant's unstructured knowledge (documents, websites) via semantic search. Powers the Business Brain feature.
- **Data Engine**: Performs real-time, structured lookups against a tenant's internal databases and APIs.
- **WhatsApp Engine**: Central orchestrator that manages live conversations.

## ğŸ› ï¸ Technology Stack

- **Frontend**: React + TypeScript with Vite (VS Code, Vercel deployment)
- **Backend**: FastAPI (DigitalOcean)
- **Database**: 
  - Hot Storage: DigitalOcean PostgreSQL (transient data, UI indexes, real-time operations)
  - Cold Storage: DigitalOcean PostgreSQL + pgvector per tenant (permanent knowledge, vector embeddings)
- **Workflow Engine**: n8n (DigitalOcean)
- **Authentication**: Clerk (migrated from Stack Auth)
- **Reverse Proxy**: Caddy (DigitalOcean)
- **CDN**: CloudFront

## ğŸŒ Domain Architecture

- **Base Domain**: flomastr.com
- **Admin Platform**: app.flomastr.com
- **Tenant Access**: app.flomastr.com/{tenant_slug}/* (path-based routing)
- **WhatsApp Engine**: engine.flomastr.com
- **n8n Automation**: {tenant_slug}.n8n.flomastr.com (per-tenant n8n containers)

## ğŸš€ Implementation Status & Development Phases

### âœ… **PHASE 1: ROUTER UNIFICATION (COMPLETED)**
**Objective**: Eliminate the dual router system that was causing critical routing conflicts and architectural fragmentation.  
**Outcome**: Unified all routes into a single, predictable system, creating a single source of truth and resolving critical errors.

### âœ… **PHASE 2: AUTH CONSOLIDATION (COMPLETED)**
**Objective**: Eliminate redundant authentication checks and API calls per route.  
**Outcome**: Implemented a centralized AuthMiddleware component that caches auth state per session, dramatically improving performance and security.

### âœ… **PHASE 3: CLERK MIGRATION (COMPLETED)**
**Objective**: Migrate from Stack Auth to Clerk for improved authentication and multi-tenant support.  
**Status**: âœ… **Migration Complete** - Clerk authentication fully implemented with path-based tenant routing

### âœ… **PHASE 4: WHATSAPP ENGINE MVP (COMPLETED)**
**Objective**: Build a new, centralized microservice for all real-time WhatsApp communication.  
**Outcome**: A containerized FastAPI service with a persistent job queue is now live at https://engine.flomastr.com.

## ğŸ Quickstart

1. **Install Docker:**
   - **Windows**: Docker Desktop
   - **macOS**: Docker Desktop  
   - **Linux**: Docker Engine + Docker Compose

2. **Start the development environment:**
```bash
# Build and start all services
docker-compose up --build

# Or use detached mode
docker-compose up -d --build
```

3. **Access the application:**
   - **Backend API**: http://localhost:8000
   - **Frontend**: http://localhost:5173 (when frontend service added)
   - **API Docs**: http://localhost:8000/docs

4. **Development workflow:**
```bash
# View logs
docker-compose logs -f

# Restart after changes
docker-compose restart backend

# Stop all services
docker-compose down
```

## ğŸ³ Docker-Native Development

### **Why Docker for FloMastr Development**

Docker eliminates the platform-specific issues that were causing development friction:

- **âœ… Universal Compatibility**: Same development experience on any OS with Docker.
- **âœ… One-Command Startup**: `docker-compose up` starts everything with proper configuration
- **âœ… Production Parity**: Development environment matches production deployment exactly
- **âœ… Dependency Isolation**: No conflicts between Python versions, Node.js versions, or package managers
- **âœ… Easy Debugging**: Container logs, shell access, and service restart capabilities

### **Docker Development Workflow**

```bash
# Start development (first time)
docker-compose up --build

# Daily development
docker-compose up

# After code changes (automatic hot reload)
# No action needed - changes reflect automatically

# View real-time logs
docker-compose logs -f backend

# Debug in container
docker-compose exec backend bash

# Clean restart
docker-compose down && docker-compose up --build
```

### **Environment Configuration**
All environment variables are managed through `docker-compose.yml`:
```yaml
services:
  backend:
    environment:
      - DATABASE_URL=postgresql://...
      - SUPER_ADMIN_EMAILS=hermann@changemastr.com
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
```

## ï¿½ Environment Configuration

## ğŸ”§ Environment Configuration

### **Docker Environment Setup**

1. **Copy environment template:**
```bash
cp .env.example .env
```

2. **Edit .env file with your values:**
```env
# Database Configuration
DATABASE_URL=postgresql://doadmin:YOUR_PASSWORD@your-db-host.com:25060/defaultdb?sslmode=require

# Authentication
CLERK_SECRET_KEY=sk_live_YOUR_CLERK_SECRET_KEY
VITE_CLERK_PUBLISHABLE_KEY=pk_live_YOUR_CLERK_PUBLISHABLE_KEY

# Super Admin Configuration  
SUPER_ADMIN_EMAILS=admin@yourcompany.com,service@yourcompany.com

# OpenAI Integration
OPENAI_API_KEY=sk-proj-YOUR_OPENAI_API_KEY
```

3. **Environment Variables are automatically loaded:**
   - Backend container loads from `.env` file
   - Frontend container receives variables via docker-compose.yml
   - No manual environment variable setup needed

### **Development Scripts**

**Quick Start (Recommended):**
```bash
# Cross-platform development script
./dev.sh start        # Linux/macOS

# Or use Docker Compose directly
docker-compose up --build

# Or use Make commands
make dev               # Start development environment
make logs              # View logs
make clean             # Clean up containers
```

### **Script Commands:**
```bash
# Development commands
./dev.sh start         # Start all services
./dev.sh start-bg      # Start in background  
./dev.sh stop          # Stop all services
./dev.sh restart       # Restart services
./dev.sh logs          # View live logs

# Service-specific commands
./dev.sh backend       # Start only backend
./dev.sh frontend      # Start only frontend

# Debugging commands
./dev.sh shell-backend # Shell access to backend
./dev.sh shell-frontend# Shell access to frontend
./dev.sh clean         # Clean up everything
```

### **Hot Storage (The Index)**
DigitalOcean Managed PostgreSQL database for:
- Transient data
- UI indexes  
- Real-time operations

### **Cold Storage (The Memory)**
Separate DigitalOcean Managed PostgreSQL + pgvector database per tenant for:
- Permanent, canonical storage
- All knowledge and vector embeddings
- Conversational memory

## ğŸ” Security Architecture

### **Authentication**: 
- **Provider**: Clerk (âœ… **Fully Implemented**)
- **Method**: JWT tokens with JWKS validation for user identity management
- **Integration**: Complete frontend (React) and backend (FastAPI) integration

### **Authorization**: 
- **Middleware**: Clerk-based authentication middleware provides single point of validation
- **Checks**: Clerk JWT validation, user roles, and tenant membership for each request
- **Super Admin**: Email-based super admin detection for system administration

### **Tenant Isolation**: 
- **Database Level**: Row-level security using tenant_id on all queries
- **API Level**: Tenant context validation on all protected endpoints  
- **Workflow Level**: Dedicated n8n Docker containers per tenant

## ï¿½ï¸ The Road Ahead: Key Initiatives

### **Phase 1: Clerk Migration (âœ… COMPLETED)**
- âœ… Remove all Stack Auth code
- âœ… Install and configure Clerk  
- âœ… Update backend authentication middleware

### **Phase 2: WhatsApp Engine Integration**
- ğŸ”„ Finalize the engine's API (real Meta/BSP integration)
- ğŸ”„ Create n8n worker workflows to use the new engine's API

### **Phase 3: Frontend & User Experience**
- ğŸ“‹ Business Brain UI
- ğŸ’¬ Conversations Dashboard  
- ï¿½ğŸ“Š Analytics & Insights

## ğŸ¯ Quality Assurance Standards

### **Testing Strategy**
- **Unit Tests**: Individual components and utility functions
- **Integration Tests**: API endpoint validation  
- **End-to-End Tests**: Complete user journey testing (login, provisioning, etc.)

### **Performance Benchmarks**
- **Page Load**: < 2 seconds initial load
- **API Response**: < 500ms average response time
- **Database Queries**: < 100ms average query time

## ğŸ¢ Production Infrastructure

### **Deployment Configuration**
- **Production Domain**: app.flomastr.com
- **Caddy Server IP**: 143.110.252.87
- **WhatsApp Engine**: https://engine.flomastr.com

### **Clerk Configuration**
- **Frontend API URL**: https://clerk.flomastr.com
- **JWKS URL**: https://clerk.flomastr.com/.well-known/jwks.json

## ğŸ—„ï¸ Data Storage Philosophy

```sql
-- Tenant Management
CREATE TABLE tenants (
    id UUID PRIMARY KEY,
    slug VARCHAR(63) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    status tenant_status DEFAULT 'active',
    n8n_url VARCHAR(255)
);

-- User & Membership Management  
CREATE TABLE tenant_memberships (
    id UUID PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(id),
    user_id VARCHAR(255) NOT NULL,
    role membership_role DEFAULT 'member',
    status membership_status DEFAULT 'active'
);
```

## Docker Development Workflow

### ï¿½ **Docker-First Development Process**

Docker eliminates all the terminal session management and platform-specific issues that were causing development friction:

### **Daily Development Commands:**

```bash
# Start development environment
docker-compose up

# Start in background (detached mode)
docker-compose up -d

# View live logs
docker-compose logs -f backend
docker-compose logs -f frontend  # when frontend service added

# Restart specific service after major changes
docker-compose restart backend

# Stop all services
docker-compose down

# Rebuild containers (after dependency changes)
docker-compose up --build
```

### **Development Features:**

#### **âœ… Hot Reloading**
- **Backend**: Code changes automatically restart FastAPI server
- **Frontend**: Vite hot module replacement (when service added)
- **No manual restarts needed** for most code changes

#### **âœ… Container Shell Access**
```bash
# Access backend container for debugging
docker-compose exec backend bash

# Run Python scripts inside container
docker-compose exec backend python migrate_schema.py

# Install additional packages (temporary)
docker-compose exec backend pip install some-package
```

#### **âœ… Easy Service Management**
```bash
# Start only backend
docker-compose up backend

# Start with specific log levels
docker-compose up backend --build

# Check service status
docker-compose ps
```

## Authentication & Authorization

### Super Admin Configuration

The application uses Clerk for authentication and has a super admin system for administrative operations like tenant provisioning.

**Super Admin Emails Configuration:**
- Set `SUPER_ADMIN_EMAILS` environment variable in `backend/.env`
- Format: comma-separated list of email addresses
- Example: `SUPER_ADMIN_EMAILS=admin@company.com,super@company.com`

**Important Notes:**
- âŒ **DO NOT add tenant emails to SUPER_ADMIN_EMAILS**
- âŒ **DO NOT add user emails that will be provisioning tenants**
- âœ… Only add dedicated admin/service account emails
- âœ… Super admin emails should be separate from regular user/tenant emails

**Example of what NOT to do:**
```bash
# WRONG - Don't add tenant emails as super admins
SUPER_ADMIN_EMAILS=hermann@changemastr.com,hermann@whappstream.com

# CORRECT - Keep admin and tenant emails separate
SUPER_ADMIN_EMAILS=hermann@changemastr.com,service@changemastr.com
```

**Why this matters:**
- Super admin access is for system administration (tenant provisioning, system config)
- Regular users should not have super admin privileges
- Mixing admin and user emails creates security and confusion issues

## Gotchas

The backend server runs on port 8000 and the frontend development server runs on port 5173. The frontend Vite server proxies API requests to the backend on port 8000.

Visit <http://localhost:5173> to view the application.

## Current Status (Docker-Native Development)

### âœ… **DEVELOPMENT ENVIRONMENT STANDARDIZED**

**ğŸ³ Docker-First Architecture - IMPLEMENTED:**
- âœ… **Problem**: Windows-specific development friction causing endless debugging sessions  
- âœ… **Root Cause**: Platform-specific Python virtual environments, PowerShell terminal issues, AsyncIO event loop problems
- âœ… **Solution**: Docker containerization eliminates all platform-specific issues
- âœ… **Result**: Universal development environment with one-command startup

**ğŸ¯ Backend Container - WORKING:**
- âœ… **Container**: Python 3.11-slim with FastAPI on port 8000
- âœ… **Database**: PostgreSQL connection (SSL) working perfectly  
- âœ… **APIs**: All 43 routes imported successfully including tenant provisioning
- âœ… **Environment**: Variables loaded from docker-compose.yml
- âœ… **Hot Reloading**: Code changes automatically restart server

**ğŸ¯ Development Workflow - STREAMLINED:**
- âœ… **One Command**: `docker-compose up` starts entire environment
- âœ… **No Setup Required**: No Python virtual environments, no Node.js version management
- âœ… **Cross-Platform**: Works identically on any system that runs Docker.
- âœ… **Production Parity**: Same environment as production deployment
- âœ… **Easy Debugging**: Container logs and shell access
- âœ… **Authentication**: Clerk JWT validation with super admin support

### âœ… **Currently Working Components**

**Containerized Backend:**
- âœ… **FastAPI**: Running in Python 3.11 container
- âœ… **Database**: PostgreSQL connection via environment variables
- âœ… **Authentication**: âœ… **Clerk fully integrated** with JWKS validation and super admin detection  
- âœ… **API Endpoints**: All routes available at http://localhost:8000
- âœ… **Hot Reloading**: Automatic server restart on code changes

**Development Tools:**
- âœ… **Docker Compose**: Single command to start/stop all services
- âœ… **Volume Mounts**: Live code editing with immediate reflection
- âœ… **Environment Management**: All variables in docker-compose.yml
- âœ… **Log Access**: Real-time logging with `docker-compose logs -f`

### ï¿½ **Ready for Efficient Development**

**Docker Development Commands:**
- âœ… **Start**: `docker-compose up` - starts entire environment
- âœ… **Background**: `docker-compose up -d` - starts in background
- âœ… **Logs**: `docker-compose logs -f backend` - view live logs
- âœ… **Debug**: `docker-compose exec backend bash` - shell access
- âœ… **Restart**: `docker-compose restart backend` - restart service
- âœ… **Stop**: `docker-compose down` - stop all services

**Next Steps:**
1. âœ… **Add Frontend Service** - containerize React frontend with hot reloading
2. âœ… **Test Full Stack** - verify frontend-backend communication in containers  
3. âœ… **Validate Workflows** - ensure all development tasks work in Docker environment

### ï¿½ **Key Benefits Achieved**

**Development Experience:**
- âœ… **Eliminated Platform Issues**: Docker containerization eliminates platform-specific development friction
- âœ… **One-Command Startup**: Single `docker-compose up` replaces complex startup scripts
- âœ… **Consistent Environment**: Same development experience regardless of operating system
- âœ… **Faster Debugging**: Container logs and shell access simplify troubleshooting

**Technical Architecture:**
- âœ… **Container Isolation**: No dependency conflicts between projects
- âœ… **Production Parity**: Development environment matches production exactly
- âœ… **Easy Scaling**: Add new services by updating docker-compose.yml
- âœ… **Version Control**: All environment configuration tracked in git
